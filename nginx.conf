log_format upstream_timing '$remote_addr - $host "$request" '
                           'uri="$uri" upstream="$upstream_addr" '
                           'status=$status upstream_status=$upstream_status '
                           'rt=$request_time urt=$upstream_response_time';

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /usr/share/nginx/html;
    index index.html;

    # Enable access log with upstream timing (helps debug 404/502 sources)
    access_log /var/log/nginx/access.log upstream_timing;

    # Resolve DNS at request time so UI starts even if deps are missing.
    # Use CoreDNS service FQDN. 'valid' controls cache TTL; 'ipv6=off' avoids AAAA lookups.
    resolver kube-dns.kube-system.svc.cluster.local valid=10s ipv6=off;
    resolver_timeout 5s;

    # Upstream service FQDNs in the *same* namespace ("default" below).
    # keep the resolver lines you already have
    set $kraken_auth            "kraken-auth:8080";
    set $nautilus_inventory     "nautilus-inventory:8084";
    set $clam_catalog           "clam-catalog:8080";
    set $codlocker_assets       "codlocker-assets:8080";
    set $squid_recommendations  "squid-recommendations:8085";
    set $barnacle_reviews       "barnacle-reviews:8080";
    set $manta_delivery         "manta-delivery:8080";
    set $octopus_payments       "octopus-payments:8080";
    set $cuttlefish_orders      "cuttlefish-orders:8080";
    set $urchin_analytics       "urchin-analytics:8080";
    set $jellyfish_notifications "jellyfish-notifications:8083";
    set $reef_feed_aggregator   "reef-feed-aggregator:8080";

    # ---- Same-origin API proxies (variables trigger lazy DNS) ----
    location /api/kraken-auth/ {
      rewrite ^/api/kraken-auth/?(.*)$ /$1 break;
      proxy_pass         http://$kraken_auth;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/nautilus-inventory/ {
      rewrite ^/api/nautilus-inventory/?(.*)$ /$1 break;
      proxy_pass         http://$nautilus_inventory;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/clam-catalog/ {
      rewrite ^/api/clam-catalog/?(.*)$ /$1 break;
      proxy_pass         http://$clam_catalog;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/codlocker-assets/ {
      rewrite ^/api/codlocker-assets/?(.*)$ /$1 break;
      proxy_pass         http://$codlocker_assets;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/squid-recommendations/ {
      rewrite ^/api/squid-recommendations/?(.*)$ /$1 break;
      proxy_pass         http://$squid_recommendations;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/barnacle-reviews/ {
      rewrite ^/api/barnacle-reviews/?(.*)$ /$1 break;
      proxy_pass         http://$barnacle_reviews;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/manta-delivery/ {
      rewrite ^/api/manta-delivery/?(.*)$ /$1 break;
      proxy_pass         http://$manta_delivery;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/octopus-payments/ {
      rewrite ^/api/octopus-payments/?(.*)$ /$1 break;
      proxy_pass         http://$octopus_payments;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/cuttlefish-orders/ {
      rewrite ^/api/cuttlefish-orders/?(.*)$ /$1 break;
      proxy_pass         http://$cuttlefish_orders;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    location /api/urchin-analytics/ {
      rewrite ^/api/urchin-analytics/?(.*)$ /$1 break;
      proxy_pass         http://$urchin_analytics;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    # SSE proxy (streaming friendly)
    location /api/jellyfish-notifications/ {
      rewrite ^/api/jellyfish-notifications/?(.*)$ /$1 break;
      proxy_pass                 http://$jellyfish_notifications;
      proxy_set_header           Host $host;
      proxy_http_version         1.1;
      proxy_set_header           Connection "";
      chunked_transfer_encoding  off;
      proxy_buffering            off;
      proxy_cache                off;
    }

    location /api/reef-feed-aggregator/ {
      rewrite ^/api/reef-feed-aggregator/?(.*)$ /$1 break;
      proxy_pass         http://$reef_feed_aggregator;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
    }

    # Asset serving proxy (images, etc)
    location /assets/ {
      proxy_pass         http://$codlocker_assets;
      proxy_set_header   Host $host;
      proxy_http_version 1.1;
      proxy_set_header   Connection "";
      expires            1y;
      add_header         Cache-Control "public, immutable";
    }

    # SPA fallback
    location / {
      try_files $uri /index.html;
    }
}