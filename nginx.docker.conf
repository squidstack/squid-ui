# Local Docker Compose Nginx config (mounted into the squid-ui container)

# Access log with upstream timing so we can debug 404/502 easily
log_format upstream_timing '$remote_addr - $host "$request" '
                           'uri="$uri" upstream="$upstream_addr" '
                           'status=$status upstream_status=$upstream_status '
                           'rt=$request_time urt=$upstream_response_time';

server {
  listen 80 default_server;
  listen [::]:80 default_server;
  root /usr/share/nginx/html;
  index index.html;

  access_log /var/log/nginx/access.log upstream_timing;

  # Docker's embedded DNS inside containers
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 2s;
  
 

  # Use service names from docker-compose (same project network)
  # SquidStack Demo: Only the 3 backend services we have
  set $kraken_auth              "kraken-auth:8080";
  set $clam_catalog             "clam-catalog:8080";
  set $codlocker_assets         "codlocker-assets:8080";

  # Strip /api/<service>/ prefix before proxying
  location /api/kraken-auth/ {
    rewrite ^/api/kraken-auth/?(.*)$ /$1 break;
    proxy_pass         http://$kraken_auth;
    proxy_set_header   Host $host;
    proxy_http_version 1.1;
    proxy_set_header   Connection "";
  }

  location /api/clam-catalog/ {
    rewrite ^/api/clam-catalog/?(.*)$ /$1 break;
    proxy_pass         http://$clam_catalog;
    proxy_set_header   Host $host;
    proxy_http_version 1.1;
    proxy_set_header   Connection "";
  }

  # Asset serving proxy (no /api prefix strip needed)
  # ^~ modifier stops nginx from checking regex locations, ensuring this takes priority
  location ^~ /assets/ {
    proxy_pass         http://$codlocker_assets;
    proxy_set_header   Host $host;
    proxy_http_version 1.1;
    proxy_set_header   Connection "";
    expires            1y;
    add_header         Cache-Control "public, immutable";
  }

   # ---- Feature management config (no cache) ----
  location /config/ {
    try_files $uri =404;
    add_header Cache-Control "no-store";
  }


  # ---- Static assets (serve as files, not SPA) ----
  location ~* \.(?:css|js|mjs|map|png|jpe?g|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    access_log off;
    expires 1y;
    add_header Cache-Control "public, immutable";
  }


  # SPA fallback
  location / {
    try_files $uri /index.html;
  }
}