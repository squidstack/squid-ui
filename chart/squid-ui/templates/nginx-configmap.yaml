apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "squid-ui.fullname" . }}-nginx
data:
  default.conf: |
    log_format upstream_timing '$remote_addr - $host "$request" '
                               'uri="$uri" upstream="$upstream_addr" '
                               'status=$status upstream_status=$upstream_status '
                               'rt=$request_time urt=$upstream_response_time';

    server {
      listen 80 default_server;
      listen [::]:80 default_server;
      root /usr/share/nginx/html;
      index index.html;

      # Access log with upstream timing
      access_log /var/log/nginx/access.log upstream_timing;

      # CoreDNS service; lazy DNS with short TTL
      resolver kube-dns.kube-system.svc.cluster.local valid=10s ipv6=off;
      resolver_timeout 5s;

      # --- All upstreams (namespace-aware, same ns as this release) ---
      # If a backend runs in a DIFFERENT namespace, change only that one.
      set $kraken_auth             "kraken-auth.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $nautilus_inventory      "nautilus-inventory.{{ .Release.Namespace }}.svc.cluster.local:8084";
      set $clam_catalog            "clam-catalog.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $codlocker_assets        "codlocker-assets.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $squid_recommendations   "squid-recommendations.{{ .Release.Namespace }}.svc.cluster.local:8085";
      set $barnacle_reviews        "barnacle-reviews.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $manta_delivery          "manta-delivery.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $octopus_payments        "octopus-payments.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $cuttlefish_orders       "cuttlefish-orders.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $urchin_analytics        "urchin-analytics.{{ .Release.Namespace }}.svc.cluster.local:8080";
      set $jellyfish_notifications "jellyfish-notifications.{{ .Release.Namespace }}.svc.cluster.local:8083";
      set $reef_feed_aggregator    "reef-feed-aggregator.{{ .Release.Namespace }}.svc.cluster.local:8080";

      # --- Proxies ---
      location /api/kraken-auth/ {
        rewrite ^/api/kraken-auth/?(.*)$ /$1 break;
        proxy_pass         http://$kraken_auth;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/nautilus-inventory/ {
        rewrite ^/api/nautilus-inventory/?(.*)$ /$1 break;
        proxy_pass         http://$nautilus_inventory;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/clam-catalog/ {
        rewrite ^/api/clam-catalog/?(.*)$ /$1 break;
        proxy_pass         http://$clam_catalog;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/squid-recommendations/ {
        rewrite ^/api/squid-recommendations/?(.*)$ /$1 break;
        proxy_pass         http://$squid_recommendations;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/barnacle-reviews/ {
        rewrite ^/api/barnacle-reviews/?(.*)$ /$1 break;
        proxy_pass         http://$barnacle_reviews;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/manta-delivery/ {
        rewrite ^/api/manta-delivery/?(.*)$ /$1 break;
        proxy_pass         http://$manta_delivery;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/octopus-payments/ {
        rewrite ^/api/octopus-payments/?(.*)$ /$1 break;
        proxy_pass         http://$octopus_payments;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/cuttlefish-orders/ {
        rewrite ^/api/cuttlefish-orders/?(.*)$ /$1 break;
        proxy_pass         http://$cuttlefish_orders;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      location /api/urchin-analytics/ {
        rewrite ^/api/urchin-analytics/?(.*)$ /$1 break;
        proxy_pass         http://$urchin_analytics;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      # SSE: streaming-friendly defaults
      location /api/jellyfish-notifications/ {
        rewrite ^/api/jellyfish-notifications/?(.*)$ /$1 break;
        proxy_pass                 http://$jellyfish_notifications;
        proxy_set_header           Host $host;
        proxy_http_version         1.1;
        proxy_set_header           Connection "";
        chunked_transfer_encoding  off;
        proxy_buffering            off;
        proxy_cache                off;
      }

      location /api/reef-feed-aggregator/ {
        rewrite ^/api/reef-feed-aggregator/?(.*)$ /$1 break;
        proxy_pass         http://$reef_feed_aggregator;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
      }

      # Asset serving proxy (images, etc)
      location /assets/ {
        proxy_pass         http://$codlocker_assets;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        expires            1y;
        add_header         Cache-Control "public, immutable";
      }

      # QUIET health endpoint
      location = /healthz {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "ok";
      }

      # SPA fallback
      location / {
        try_files $uri /index.html;
      }
    }